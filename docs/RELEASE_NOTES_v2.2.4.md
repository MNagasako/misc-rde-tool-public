# ARIM RDE Tool - Release Notes v2.2.4

**リリース日**: 2025年12月10日

---

## 概要

v2.2.4 は設備/報告書データの閲覧UXと長時間ジョブの効率化にフォーカスしたリリースです。Equipment / Reports 各タブにフィルタ可能なリスティングビューを追加し、エクスポートしたJSONを外部ツールなしで即座に確認できます。報告書取得ではキャッシュマネージャとキャッシュモード切り替えUIを導入し、再取得コストを抑えながら必要に応じて強制再取得も行えるようになりました。さらに Basic Info の検索設定ダイアログと設備一覧スクレイパーを整備し、バッチ検索や全件取得ワークフローの構成が容易になります。

---

## 主要な改善点

### 🧾 フィルタ可能な設備/報告書リスティングタブ
- `ListingTabBase` + `ListingFilterProxyModel` による共通テーブルウィジェットを実装し、列ごとのフィルタ/ソート/幅調整/件数表示を標準化。
- EquipmentListingTab / ReportListingTab から最新JSONを再読込し、長文フィールドを自動トリミング + ツールチップ表示で確認可能。
- 読み込み元ファイル名と更新時刻(JST)をステータスラベルに表示し、エクスポート→レビュー→再実行の手戻りを削減。

### 💾 ReportCacheManager とキャッシュモード選択
- `ReportCacheManager` と `ReportCacheMode` を追加し、取得済みコードをディスクキャッシュから再利用する SKIP モードと常に最新を取得する OVERWRITE モードを切替。
- Fetchタブ/並列フェッチャー/バッチワーカー/ファイルエクスポータがキャッシュ保存・命中件数を統合ログ出力し、長時間ジョブの再実行を高速化。
- UI から現在のキャッシュ方針を明示し、ログにも「キャッシュ: 再利用 / 強制再取得」を出力してトラブルシューティングを容易に。

### 🔍 Basic Info 検索設定ダイアログ
- `BasicInfoSearchDialog` を新設し、自分のデータセット/キーワード直接指定/機関ID+年度レンジの3モードを切り替えて検索キューを構成可能。
- 助成番号プレフィックス + 機関ID + 年度レンジからキーワードを自動生成し、プレビューで生成例を表示。バッチ検索の作成や再実行が安全に。
- 前回の選択状態を保存して次回起動時に復元し、検索方法の切り替えや連続ジョブの設定を省力化。

### 🛰 設備一覧スクレイパーと全件取得サポート
- `FacilityListingScraper` が facility.php?mode=search を巡回し、100件単位のページを自動ダウンロード→設備IDを抽出→重複排除。
- 取得件数・ページ進行状況をログ/コールバックで通知し、キャンセルや範囲指定にも対応。
- 全件取得モードと連続不在判定を設備タブの新UIと連携させ、設備JSONキャッシュの欠損検知と再取得をワンクリックで実施可能。

---

## テスト状況

- `pytest -q -k "listing_support or equipment_tabs_refresh or report_tabs_refresh"` : リスティングテーブル/タブの単体・ウィジェットテストが全て合格。
- `pytest -q -k "report_cache_manager or report_cache_mode"` : キャッシュマネージャとキャッシュモード切替ロジックのテストが合格。
- `pytest -q -k "basic_info_search_dialog"` : 新ダイアログのセレクション生成とテーマ反映を検証。

---

## 既知の問題 / 注意事項

- リスティングタブは最新JSONファイルのみを対象とします。複数世代のファイルを比較する場合は従来通り外部エディタで開いてください。
- ReportCacheManager のキャッシュディレクトリは `output/arim-site/reports/cache/` です。ストレージ容量がひっ迫する場合は不要な JSON を手動削除してください。
- FacilityListingScraper は HTML 構造の変更に依存するため、Nanomaterialサイト側のUI改修が入った場合は早急なアップデートが必要です。

---

## アップグレード手順

1. v2.2.4 バイナリ/ソースを取得し、`.venv` を有効化して起動します。
2. Equipment/Reports タブから最新JSONを出力し、新しいリスティングタブでフィルタ/検索/再読込が機能することを確認します。
3. Report Fetch タブでキャッシュモードを切り替え、`output/arim-site/reports/cache/` に JSON が保存されること・ログにキャッシュ種別が表示されることを確認します。
4. 基本情報タブで検索ボタンを押し、新しい検索設定ダイアログからキーワード生成→検索実行→まとめXLSX出力までを通しでテストします。
5. 設備タブの全件取得ワークフローを実行し、FacilityListingScraper のログと取得件数が期待値通りであること、欠損検知が実行されることを確認します。
