# 05. データ登録機能 - 詳細仕様書

## 概要
ARIM RDE Toolのデータ登録機能は、研究データファイルを既存のデータセットに登録・アップロードする機能です。動的なスキーマフォーム生成、試料情報管理、添付ファイル処理、メタデータ自動生成により、効率的なデータ管理を実現します。

## 実装ファイル
- **メインロジック**: `src/logic/data_register_logic.py`
- **UI制御**: `src/classes/ui_controller.py`
- **スキーマ管理**: `src/logic/schema_form_util.py`
- **試料管理**: `src/classes/sample_manager.py`

## 主要機能

### 1. データセット選択
- **ドロップダウン選択**: 利用可能データセットの一覧表示
- **検索機能**: データセット名での絞り込み検索
- **権限確認**: 登録権限のあるデータセットのみ表示
- **詳細表示**: 選択したデータセットの詳細情報表示

### 2. 動的スキーマフォーム
- **自動生成**: データセットスキーマに基づくフォーム生成
- **項目種別対応**: テキスト、数値、日付、選択肢、ファイル等
- **バリデーション**: リアルタイム入力検証
- **条件分岐**: 入力値に応じた項目表示制御

### 3. 試料情報管理
- **既存試料選択**: 登録済み試料からの選択
- **新規試料入力**: 新しい試料情報の入力
- **検索補完**: 試料名の部分一致検索
- **試料詳細**: 組成、説明、参照URL等の管理

### 4. ファイル管理
- **データファイル選択**: 主要な研究データファイル
- **添付ファイル選択**: 補助的なファイル・画像等
- **複数ファイル対応**: 複数ファイルの一括選択・アップロード
- **ファイル情報**: ファイルサイズ、形式、メタデータの自動取得

## UI構成

### データ登録モード時のレイアウト
```
[データ登録フォーム]
┌─────────────────────────────────────┐
│ ■ データセット選択                   │
│   データセット: [既存データセット ▼] │
│   [選択データセットの詳細情報]       │
│                                     │
│ ■ 基本情報                          │
│   データ名: [___________________]   │
│   基本説明: [___________________]   │
│   実験ID: [____________________]    │
│                                     │
│ ■ 試料情報                          │
│   [動的試料フォーム]                │
│                                     │
│ ■ カスタム項目                      │
│   [動的スキーマフォーム]            │
│                                     │
│ ■ ファイル選択                      │
│   データファイル: [ファイル選択]     │
│   添付ファイル: [ファイル選択]       │
│                                     │
│ [プレビュー] [登録実行]              │
└─────────────────────────────────────┘
```

### UIコンポーネントの詳細

#### 1. データセット選択
- **フィルタリング**: 権限のあるデータセットのみ表示
- **詳細情報**: 選択時にデータセット詳細を表示
- **スキーマ表示**: 必要な入力項目の事前確認
- **最近使用**: 最近使用したデータセットの優先表示

#### 2. 基本情報入力
- **データ名**: 登録するデータの識別名
- **基本説明**: データの概要・目的説明
- **実験ID**: 実験・測定の識別番号
- **バリデーション**: 必須項目・形式チェック

#### 3. 動的試料フォーム
- **既存試料選択**: ドロップダウンでの選択
- **試料名**: 複数の試料名に対応
- **試料説明**: 詳細な説明文
- **組成・分子式**: 化学組成情報
- **検索補完**: 部分一致での試料名検索

#### 4. 動的スキーマフォーム
- **自動生成**: データセットスキーマからの自動生成
- **多様な入力タイプ**: テキスト、数値、日付、選択肢等
- **カスタムバリデーション**: スキーマ定義に基づく検証
- **ヘルプ表示**: 各項目の説明・入力例表示

#### 5. ファイル選択
- **データファイル**: メインの研究データファイル
- **添付ファイル**: 補助的なファイル・画像
- **ドラッグ&ドロップ**: 直感的なファイル選択
- **プレビュー**: 選択ファイルの詳細情報表示

## 技術仕様

### 1. データ登録フロー
```python
def register_data(dataset_info, form_values, files):
    """データ登録の全体フロー"""
    1. データセット権限確認
    2. 入力データバリデーション
    3. ファイルアップロード準備
    4. メタデータ生成
    5. API呼び出し (POST /api/data)
    6. ファイルアップロード実行
    7. 登録完了通知
```

### 2. スキーマフォーム生成
```python
def generate_schema_form(schema):
    """スキーマに基づく動的フォーム生成"""
    1. スキーマ定義解析
    2. フィールドタイプ判定
    3. UIコンポーネント選択
    4. レイアウト構築
    5. バリデーションルール設定
    6. イベントハンドラー設定
```

### 3. データ構造
```json
{
  "data_entry": {
    "name": "データ名",
    "description": "基本説明",
    "experiment_id": "実験ID",
    "dataset_id": "データセットID",
    "sample": {
      "names": ["試料名1", "試料名2"],
      "description": "試料説明",
      "composition": "化学組成",
      "reference_url": "参照URL"
    },
    "custom_fields": {
      "field1": "value1",
      "field2": "value2"
    },
    "files": [
      {
        "type": "data|attachment",
        "filename": "ファイル名",
        "size": 12345,
        "checksum": "md5ハッシュ"
      }
    ]
  }
}
```

## 試料情報管理

### 1. 試料データベース
- **ファイル形式**: JSON形式での試料情報保存
- **保存場所**: `output/rde/data/samples/{group_id}.json`
- **検索インデックス**: 高速検索のためのインデックス
- **バックアップ**: 定期的なデータバックアップ

### 2. 試料検索・補完
```python
def search_samples(query, group_id):
    """試料検索・補完機能"""
    1. 試料データファイル読み込み
    2. 部分一致検索実行
    3. 候補リスト生成
    4. 表示用フォーマット変換
    5. UI更新
```

### 3. 試料情報の統合
- **新規作成**: 入力された情報での新規試料作成
- **既存更新**: 既存試料情報の部分更新
- **重複排除**: 同一試料の重複登録防止
- **履歴管理**: 試料情報の変更履歴保持

## ファイル処理機能

### 1. ファイルアップロード
- **チャンク分割**: 大容量ファイルの分割アップロード
- **プログレス表示**: アップロード進捗のリアルタイム表示
- **エラー処理**: 失敗時の自動再試行機能
- **整合性チェック**: アップロード後のファイル整合性確認

### 2. メタデータ抽出
```python
def extract_file_metadata(file_path):
    """ファイルメタデータ自動抽出"""
    1. ファイル基本情報取得
    2. MIMEタイプ判定
    3. 形式固有メタデータ抽出
    4. サムネイル生成（画像の場合）
    5. 検索インデックス更新
```

### 3. ファイル種別対応
- **測定データ**: CSV、Excel、HDF5等
- **画像**: JPEG、PNG、TIFF、SVG等
- **文書**: PDF、Word、PowerPoint等
- **その他**: ZIP、RAR、専門形式等

## バリデーション機能

### 1. 入力値検証
- **必須項目**: スキーマ定義に基づく必須チェック
- **データ型**: 数値、日付、メール等の形式検証
- **文字数制限**: 最小・最大文字数の確認
- **正規表現**: パターンマッチングでの形式確認

### 2. ファイル検証
- **サイズ制限**: ファイルサイズの上限チェック
- **形式制限**: 許可されたファイル形式の確認
- **ウイルススキャン**: セキュリティチェック
- **整合性確認**: ファイル破損の検出

### 3. 関連性検証
- **試料整合性**: 試料情報とデータの関連性確認
- **実験整合性**: 実験IDとデータの整合性確認
- **重複チェック**: 同一データの重複登録防止
- **権限確認**: データセットへの登録権限確認

## API連携

### 1. データ登録API
- **エンドポイント**: `POST /api/datasets/{id}/data`
- **認証**: Bearer Token認証
- **ペイロード**: JSON形式のデータ情報
- **レスポンス**: 登録されたデータのID・URL

### 2. ファイルアップロードAPI
- **エンドポイント**: `POST /api/data/{id}/files`
- **形式**: multipart/form-data
- **チャンク対応**: 大容量ファイルの分割アップロード
- **プログレス**: アップロード進捗の取得API

### 3. メタデータAPI
- **取得**: `GET /api/datasets/{id}/schema`
- **試料情報**: `GET /api/datasets/{id}/samples`
- **ファイル情報**: `GET /api/data/{id}/files`
- **バリデーション**: `POST /api/datasets/{id}/validate`

## エラーハンドリング

### 1. 入力エラー
- **必須項目未入力**: 該当項目のハイライト表示
- **形式エラー**: 具体的な修正方法の提示
- **ファイルエラー**: ファイル問題の詳細説明
- **権限エラー**: アクセス権限の不足説明

### 2. アップロードエラー
- **ネットワークエラー**: 接続問題時の再試行機能
- **容量制限**: ストレージ容量不足の警告
- **タイムアウト**: 長時間処理の中断・再開
- **破損検出**: ファイル破損時の再アップロード

### 3. システムエラー
- **API通信エラー**: サーバー通信問題の処理
- **データベースエラー**: データ保存問題の処理
- **並行性エラー**: 同時アクセス時の競合処理
- **リソース不足**: システムリソース不足の処理

## セキュリティ対策

### 1. ファイルセキュリティ
- **ウイルススキャン**: アップロードファイルのスキャン
- **拡張子チェック**: 危険な拡張子のブロック
- **サイズ制限**: 過大なファイルのアップロード防止
- **コンテンツ検証**: ファイル内容の安全性確認

### 2. データ保護
- **暗号化**: 保存データの暗号化
- **アクセス制御**: 適切な権限ベースアクセス
- **監査ログ**: 操作履歴の記録・監視
- **バックアップ**: 定期的なデータバックアップ

### 3. 通信セキュリティ
- **HTTPS**: 暗号化通信の強制
- **認証**: Bearer Token認証の実装
- **CSRF対策**: クロスサイトリクエストフォージェリ対策
- **入力サニタイズ**: 悪意ある入力の無害化

## 今後の改善予定

### 1. 機能拡張
- **バッチ登録**: 複数データの一括登録
- **自動化**: 定期的なデータ登録の自動化
- **外部連携**: 測定機器からの直接データ取得

### 2. UI/UX改善
- **ドラッグ&ドロップ**: ファイル選択の簡素化
- **プレビュー強化**: データ内容の事前確認
- **テンプレート**: よく使用する設定のテンプレート化

### 3. データ管理
- **バージョン管理**: データの版管理機能
- **変更履歴**: データ修正の履歴管理
- **関連性**: データ間の関連性管理強化

---

**更新履歴**
- v1.12.0: 動的スキーマフォーム機能の実装、UI/UX改善
- v1.11.0: 試料情報管理機能の強化
- v1.10.0: 基本的なデータ登録機能の実装
