# 01. ログイン機能 - 詳細仕様書

## 概要
ARIM RDE Toolのログイン機能は、PyQt5のWebEngineViewを使用してRDEシステムへの自動ログインを実現しています。セキュアなCookie管理とBearer Token認証により、ユーザーのセッション状態を適切に維持します。

- **UI制御**: `src/classes/ui_controller.py`
- **設定ファイル**: `src/config/site_rde.py`

## 主要機能
### 1. 自動ログイン機能
- **実装場所**: `LoginManager.auto_login()`
- **機能**: 保存されたログイン情報を使用してRDEシステムに自動ログイン
- **設定ファイル**: `input/login.txt`
  ```
  user_id=your_user_id
  password=your_password
  ```

### 2. WebEngineView統合
- **WebView表示制御**: モード切替時の表示/非表示管理
- **サイズ調整**: ログイン状態に応じた適切なサイズ設定
- **オーバーレイ管理**: ログイン画面とメニューの適切な重ね合わせ

### 3. Cookie・セッション管理
- **Cookie保存場所**: 各種Cookieファイル
- **Bearer Token**: ログイン成功時にBearer Tokenを取得・保存
- **セッション維持**: アプリ起動中のセッション状態維持

## UI構成

### ログインモード時のレイアウト
```
[左側メニュー]     [右側WebView]
┌─────────┐    ┌──────────────────┐
│ データ取得  │    │                  │
│ データ開設  │    │   RDEログイン画面   │
│ データ登録  │    │                  │
│ 設定      │    │                  │
│ ─────── │    │                  │
│ 閉じる     │    │                  │
└─────────┘    └──────────────────┘
```

### UIコンポーネント
- **WebEngineView**: メインのブラウザコンポーネント
- **自動ログインメッセージ**: 上部にログイン状況を表示
- **WebViewメッセージ**: WebView操作ガイド表示

## 技術仕様

### 1. 認証フロー
```python
def auto_login(self):
    """自動ログイン処理"""
    1. ログイン設定ファイル読み込み (input/login.txt)
    2. RDEログインページへアクセス
    3. 認証情報の自動入力
    4. ログイン実行
    5. Bearer Token取得・保存
    6. セッション状態の確認
```

### 2. Cookie管理
- **保存場所**: プロファイル別のCookieストレージ
- **暗号化**: セキュアなCookie保存機能
- **有効期限**: セッション管理とタイムアウト制御

### 3. エラーハンドリング
- **ネットワークエラー**: 接続失敗時の適切な処理
- **認証エラー**: ログイン失敗時のユーザー通知
- **タイムアウト**: 長時間応答なしの場合の処理

## 設定ファイル

### login.txt の形式
```ini
# RDEシステムログイン情報
user_id=your_username
password=your_password

# オプション設定
auto_login=true
save_session=true
```

### site_rde.py の設定項目
```python
URLS = {
    'LOGIN': 'https://rde.nims.go.jp/login',
    'HOME': 'https://rde.nims.go.jp/home',
    # その他のエンドポイント...
}
```

## セキュリティ対策

### 1. 認証情報の保護
- ログイン情報のローカルファイル保存
- パスワードの平文保存（ローカル環境のみ）
- セッション情報の適切な管理

### 2. 通信セキュリティ
- HTTPS通信の強制
- SSL証明書の検証
- セキュアなCookie属性設定

### 3. セッション管理
- 適切なタイムアウト設定
- セッション有効性の定期確認
- 不正アクセス防止機能

## 使用方法

### 1. 初回設定
1. `input/login.txt.sample` を `input/login.txt` にコピー
2. ユーザーIDとパスワードを設定
3. アプリケーション起動

### 2. ログイン実行
1. アプリケーション起動時に自動実行
2. 手動ログイン: ログインボタンクリック
3. ログイン状況の確認: メッセージ表示で状態確認

### 3. セッション維持
- アプリケーション実行中はセッション維持
- 再起動時は自動ログイン実行
- 長時間使用時は定期的な認証確認

## トラブルシューティング

### よくある問題と対処法
1. **ログイン失敗**
   - 認証情報の確認
   - ネットワーク接続の確認
   - RDEシステムの状態確認

2. **セッション切れ**
   - 再ログインの実行
   - Cookie情報のクリア
   - アプリケーションの再起動

3. **WebView表示問題**
   - ブラウザキャッシュのクリア
   - 表示サイズの調整
   - オーバーレイ設定の確認

## 今後の改善予定

### 1. 認証方式の拡張
- 二要素認証対応
- SSO (Single Sign-On) 対応
- API Key認証の実装

### 2. UI/UX改善
- ログイン状況の詳細表示
- エラーメッセージの改善
- プログレス表示の強化

### 3. セキュリティ強化
- 認証情報の暗号化保存
- セッション管理の強化
- 監査ログ機能の追加

---

**更新履歴**
- v1.12.0: UI/UX大幅改善、WebView制御の最適化
- v1.11.0: セッション管理の安定化
- v1.10.0: プログレス表示システムの統合
