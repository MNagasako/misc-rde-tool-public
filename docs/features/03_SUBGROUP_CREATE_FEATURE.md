# 03. サブグループ作成機能 - 詳細仕様書

## 概要
ARIM RDE Toolのサブグループ作成機能は、研究グループ内にサブグループを作成し、メンバー管理、課題番号設定、研究資金情報の管理を行う機能です。タブ形式のUIにより、新規作成と修正の両方に対応しています。

## 実装ファイル
- **UI制御**: `src/classes/ui_controller.py`
- **サブグループウィジェット**: `src/classes/subgroup_create_widget.py`
- **ロジック**: `src/logic/subgroup_create_logic.py`
- **設定**: `src/config/subgroup_settings.py`

## 主要機能

### 1. タブ形式UI
- **新規作成タブ**: 新しいサブグループの作成
- **修正タブ**: 既存サブグループの編集・修正
- **タブ切替**: シームレスな機能切替

### 2. 新規サブグループ作成
- **基本情報設定**: グループ名、説明文
- **メンバー管理**: メールアドレスによる検索・追加
- **課題番号管理**: 複数課題番号の設定
- **研究資金管理**: 資金番号・種別の設定

### 3. 既存サブグループ修正
- **グループ選択**: 既存グループの一覧表示・選択
- **情報更新**: 基本情報の修正
- **メンバー変更**: メンバーの追加・削除
- **課題情報更新**: 課題番号・資金情報の更新

## UI構成

### サブグループ作成モード時のレイアウト
```
[タブエリア]
┌─────────────────────────────────────┐
│ [新規作成] [修正]                 │
└─────────────────────────────────────┘

[新規作成タブ内容]
┌─────────────────────────────────────┐
│ ■ 基本情報                          │
│   グループ名: [________________]    │
│   説明: [________________________] │
│                                     │
│ ■ メンバー管理                      │
│   メールアドレス: [______________]   │
│   [メンバー追加] [メンバー削除]      │
│   [現在のメンバー一覧]              │
│                                     │
│ ■ 課題番号                          │
│   課題番号: [__________________]    │
│   課題名: [____________________]    │
│   [課題追加] [課題削除]              │
│                                     │
│ ■ 研究資金                          │
│   資金番号: [__________________]    │
│   [資金追加] [資金削除]              │
│                                     │
│ [サブグループ作成実行]               │
└─────────────────────────────────────┘

[修正タブ内容]
┌─────────────────────────────────────┐
│ ■ サブグループ選択                   │
│   [既存グループ一覧 ▼]              │
│   [選択グループの詳細情報表示]       │
│                                     │
│ ■ 修正内容                          │
│   [新規作成と同様のフォーム]         │
│                                     │
│ [修正実行] [削除]                   │
└─────────────────────────────────────┘
```

### UIコンポーネントの詳細

#### 1. タブコントロール
- **新規作成タブ**: 完全新規でのサブグループ作成
- **修正タブ**: 既存サブグループの編集・削除

#### 2. 基本情報入力
- **グループ名**: サブグループの識別名
- **説明**: グループの目的・概要説明
- **バリデーション**: 必須項目チェック・文字数制限

#### 3. メンバー管理
- **メール検索**: RDEユーザーのメールアドレス検索
- **メンバー追加**: 検索結果からのメンバー選択・追加
- **メンバー削除**: 現在のメンバーからの削除
- **権限設定**: メンバーの権限レベル設定

#### 4. 課題番号管理
- **課題番号入力**: 研究課題の識別番号
- **課題名入力**: 課題の正式名称
- **複数課題**: 一つのサブグループに複数課題を関連付け
- **課題検索**: 既存課題番号からの検索・選択

#### 5. 研究資金管理
- **資金番号入力**: 研究資金の識別番号
- **資金種別**: 科研費、JST、NEDOなどの分類
- **複数資金**: 複数の研究資金の管理
- **期間設定**: 資金の有効期間設定

## 技術仕様

### 1. サブグループ作成フロー
```python
def create_subgroup(group_data):
    """サブグループ作成の全体フロー"""
    1. 入力データバリデーション
    2. メンバー存在確認
    3. 課題番号重複チェック
    4. API呼び出し (POST /api/subgroups)
    5. 作成結果の確認
    6. 成功通知・エラーハンドリング
```

### 2. データ構造
```json
{
  "subgroup": {
    "name": "サブグループ名",
    "description": "グループの説明",
    "members": [
      {
        "email": "user@example.com",
        "role": "member|admin",
        "joined_date": "2025-01-01"
      }
    ],
    "projects": [
      {
        "project_id": "課題番号",
        "project_name": "課題名",
        "start_date": "2025-01-01",
        "end_date": "2027-12-31"
      }
    ],
    "funding": [
      {
        "funding_id": "資金番号",
        "funding_type": "科研費|JST|NEDO|その他",
        "amount": 10000000,
        "period": "2025-2027"
      }
    ]
  }
}
```

### 3. API エンドポイント
- **作成**: `POST /api/subgroups`
- **取得**: `GET /api/subgroups/{id}`
- **更新**: `PUT /api/subgroups/{id}`
- **削除**: `DELETE /api/subgroups/{id}`
- **一覧**: `GET /api/subgroups`

## バリデーション機能

### 1. 入力値検証
- **必須項目チェック**: グループ名、最低1名のメンバー
- **文字数制限**: 各項目の適切な文字数制限
- **形式チェック**: メールアドレス、課題番号の形式確認
- **重複チェック**: 同名グループ、重複メンバーの確認

### 2. 権限確認
- **作成権限**: サブグループ作成権限の確認
- **メンバー権限**: 追加するメンバーの権限確認
- **課題権限**: 課題番号の使用権限確認

### 3. データ整合性
- **メンバー存在確認**: RDEシステム内のユーザー存在確認
- **課題番号確認**: 有効な課題番号かの確認
- **資金情報確認**: 研究資金情報の妥当性確認

## Excel連携機能

### 1. 一括作成機能
- **Excel読み込み**: 事前準備されたExcelファイルからの一括作成
- **テンプレート提供**: サブグループ作成用のExcelテンプレート
- **検証機能**: Excel内容の事前検証

### 2. Excelテンプレート構成
```
[シート1: 基本情報]
グループ名 | 説明 | 作成者

[シート2: メンバー]
グループ名 | メールアドレス | 権限

[シート3: 課題]
グループ名 | 課題番号 | 課題名 | 期間

[シート4: 資金]
グループ名 | 資金番号 | 資金種別 | 金額
```

### 3. 処理フロー
```python
def import_from_excel(excel_file):
    """Excelからの一括インポート"""
    1. Excelファイル読み込み
    2. シート別データ解析
    3. データ整合性チェック
    4. プレビュー表示
    5. ユーザー確認
    6. 一括作成実行
```

## エラーハンドリング

### 1. 入力エラー
- **必須項目未入力**: 該当項目のハイライト表示
- **形式エラー**: 具体的な修正方法の提示
- **重複エラー**: 既存データとの重複内容表示

### 2. システムエラー
- **API通信エラー**: ネットワーク問題時の適切な処理
- **権限エラー**: 権限不足時の詳細説明
- **サーバーエラー**: サーバー側問題時の対処法提示

### 3. データエラー
- **不正データ**: データ形式・内容の不正時の処理
- **競合状態**: 同時編集時の競合解決
- **整合性エラー**: データ間の矛盾時の警告

## セキュリティ対策

### 1. 入力値サニタイゼーション
- **XSS対策**: HTMLタグの適切なエスケープ
- **SQLインジェクション対策**: パラメータ化クエリの使用
- **CSRF対策**: トークンベースの検証

### 2. 権限制御
- **作成権限**: サブグループ作成権限の厳密な確認
- **編集権限**: 編集操作の権限レベル確認
- **削除権限**: 削除操作の特別な権限確認

### 3. 監査ログ
- **作成ログ**: サブグループ作成の詳細記録
- **変更ログ**: 修正操作の履歴管理
- **アクセスログ**: 機能使用状況の記録

## 今後の改善予定

### 1. 機能拡張
- **承認ワークフロー**: サブグループ作成の承認プロセス
- **テンプレート機能**: よく使用される設定のテンプレート化
- **一括操作**: 複数サブグループの一括処理

### 2. UI/UX改善
- **ウィザード形式**: ステップバイステップの作成ガイド
- **プレビュー機能**: 作成前の設定内容プレビュー
- **検索機能**: 既存サブグループの高度な検索

### 3. 連携機能
- **外部システム連携**: 他の研究管理システムとの連携
- **API拡張**: より詳細なAPI機能の提供
- **同期機能**: 外部データとの自動同期

---

**更新履歴**
- v1.12.0: タブ形式UIの実装、修正機能の追加
- v1.11.0: Excel連携機能の強化
- v1.10.0: 基本的なサブグループ作成機能の実装
