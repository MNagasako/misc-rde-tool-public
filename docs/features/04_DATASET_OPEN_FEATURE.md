# 04. データセット開設機能 - 詳細仕様書

## 概要
ARIM RDE Toolのデータセット開設機能は、既存のサブグループまたは新規グループに対してデータセットを作成・開設する機能です。スキーマ設定、メタデータ管理、アクセス権限設定を総合的に行い、研究データの適切な管理環境を構築します。

## 実装ファイル
- **メインロジック**: `src/logic/dataset_open_logic.py`
- **UI制御**: `src/classes/ui_controller.py`
- **スキーマ管理**: `src/logic/schema_form_util.py`
- **データセット管理**: `src/classes/dataset_manager.py`

## 主要機能

### 1. データセット基本設定
- **データセット名**: 識別しやすい名称設定
- **説明文**: データセットの目的・内容説明
- **カテゴリ分類**: 研究分野・データ種別の分類
- **公開レベル**: パブリック・プライベート・制限付き

### 2. スキーマ設定
- **テンプレート選択**: 既存スキーマテンプレートの選択
- **カスタムスキーマ**: 独自データ構造の定義
- **メタデータ項目**: 必須・オプション項目の設定
- **検証ルール**: データ入力時の検証条件設定

### 3. アクセス権限管理
- **所有者設定**: データセット管理者の指定
- **共同編集者**: 編集権限を持つメンバー設定
- **閲覧者**: 読み取り専用アクセス権限設定
- **外部共有**: 外部ユーザーとの共有設定

## UI構成

### データセット開設モード時のレイアウト
```
[データセット開設フォーム]
┌─────────────────────────────────────┐
│ ■ 基本情報                          │
│   データセット名: [_______________]  │
│   説明: [_________________________] │
│   カテゴリ: [研究分野 ▼] [データ種別 ▼] │
│                                     │
│ ■ 所属グループ                      │
│   サブグループ: [既存グループ ▼]     │
│   または [新規グループ作成]         │
│                                     │
│ ■ スキーマ設定                      │
│   テンプレート: [テンプレート選択 ▼] │
│   [カスタムスキーマ設定]            │
│                                     │
│ ■ メタデータ設定                    │
│   [動的生成フォーム]                │
│                                     │
│ ■ アクセス権限                      │
│   公開レベル: [パブリック ▼]        │
│   共同編集者: [ユーザー選択]        │
│                                     │
│ [プレビュー] [データセット開設実行]  │
└─────────────────────────────────────┘
```

### UIコンポーネントの詳細

#### 1. 基本情報入力
- **データセット名**: 一意性チェック付き名称入力
- **説明文**: リッチテキストエディタでの詳細説明
- **カテゴリ選択**: 階層構造での分類選択
- **タグ設定**: 検索性向上のためのタグ管理

#### 2. グループ設定
- **既存グループ選択**: ドロップダウンでの選択
- **新規グループ作成**: サブグループ作成機能との連携
- **権限継承**: グループ権限の自動継承設定
- **独立設定**: グループとは独立した権限設定

#### 3. スキーマ管理
- **テンプレート一覧**: 利用可能なスキーマテンプレート
- **プレビュー機能**: 選択したテンプレートの構造表示
- **カスタマイズ**: テンプレートの部分修正
- **独自スキーマ**: 完全カスタムスキーマの作成

#### 4. 動的メタデータフォーム
- **自動生成**: スキーマに基づく入力フォーム生成
- **バリデーション**: リアルタイム入力検証
- **条件分岐**: 入力値に応じた項目表示制御
- **デフォルト値**: 一般的な値の自動設定

## 技術仕様

### 1. データセット開設フロー
```python
def create_dataset(dataset_config):
    """データセット開設の全体フロー"""
    1. 基本情報バリデーション
    2. グループ権限確認
    3. スキーマ妥当性検証
    4. メタデータ整合性チェック
    5. API呼び出し (POST /api/datasets)
    6. 初期設定の適用
    7. 成功通知・URL発行
```

### 2. スキーマ定義構造
```json
{
  "schema": {
    "name": "データセットスキーマ名",
    "version": "1.0",
    "fields": [
      {
        "name": "field_name",
        "type": "string|number|date|boolean|file",
        "required": true,
        "description": "フィールドの説明",
        "validation": {
          "min_length": 1,
          "max_length": 255,
          "pattern": "^[a-zA-Z0-9_]+$"
        },
        "options": ["選択肢1", "選択肢2"]
      }
    ],
    "relationships": [
      {
        "from": "field1",
        "to": "field2",
        "type": "dependency|conditional"
      }
    ]
  }
}
```

### 3. API エンドポイント
- **作成**: `POST /api/datasets`
- **設定取得**: `GET /api/datasets/{id}/config`
- **スキーマ更新**: `PUT /api/datasets/{id}/schema`
- **権限設定**: `PUT /api/datasets/{id}/permissions`
- **削除**: `DELETE /api/datasets/{id}`

## スキーマ管理機能

### 1. テンプレートシステム
- **標準テンプレート**: 一般的な研究データ向けテンプレート
- **分野別テンプレート**: 材料科学、化学、物理学等の専門テンプレート
- **機関テンプレート**: 機関固有の要件に対応したテンプレート
- **カスタムテンプレート**: ユーザー作成のテンプレート保存

### 2. スキーマエディタ
- **ビジュアルエディタ**: ドラッグ&ドロップでの項目配置
- **プロパティ設定**: 各項目の詳細設定パネル
- **プレビュー機能**: 編集中スキーマの実際の表示確認
- **バリデーション**: スキーマ定義の妥当性チェック

### 3. 動的フォーム生成
```python
def generate_form_from_schema(schema):
    """スキーマからの動的フォーム生成"""
    1. スキーマ解析
    2. フィールドタイプ判定
    3. UIコンポーネント選択
    4. バリデーションルール設定
    5. レイアウト生成
    6. イベントハンドラー設定
```

## メタデータ管理

### 1. 標準メタデータ
- **Dublin Core**: 国際標準メタデータ項目
- **DataCite**: データ引用のためのメタデータ
- **研究分野固有**: 各分野の標準的なメタデータ
- **機関要件**: 機関固有の必須メタデータ

### 2. 自動補完機能
- **既存データ参照**: 過去の入力データからの推定
- **外部API連携**: 外部データベースからの情報取得
- **テンプレート値**: よく使用される値の提案
- **計算値**: 他の項目から自動計算される値

### 3. 品質管理
- **必須項目チェック**: 最低限必要な情報の確認
- **形式検証**: データ形式の妥当性確認
- **関連性チェック**: 項目間の論理的整合性確認
- **完成度評価**: メタデータの充実度評価

## アクセス権限システム

### 1. 権限レベル
- **所有者**: 全権限（削除、権限変更等）
- **管理者**: 設定変更、メンバー管理権限
- **編集者**: データ追加・修正権限
- **投稿者**: データ追加のみ権限
- **閲覧者**: 読み取り専用権限

### 2. 公開設定
- **パブリック**: 全ユーザーがアクセス可能
- **機関内限定**: 同一機関内のユーザーのみ
- **グループ限定**: 指定グループのメンバーのみ
- **プライベート**: 明示的に権限付与されたユーザーのみ

### 3. 期限付きアクセス
- **一時的共有**: 期限付きのアクセス権限
- **自動取り消し**: 期限到達時の自動権限削除
- **通知機能**: 期限前の事前通知
- **延長申請**: 権限延長の申請機能

## Excel連携機能

### 1. 一括開設
- **Excelテンプレート**: データセット情報のExcel形式入力
- **バッチ処理**: 複数データセットの一括作成
- **エラーレポート**: 処理失敗時の詳細レポート
- **進捗表示**: 一括処理の進捗状況表示

### 2. 設定エクスポート
- **設定書き出し**: 既存データセット設定のExcel出力
- **テンプレート生成**: 設定を基にしたテンプレート作成
- **比較機能**: 複数データセット設定の比較表示
- **標準化**: 機関内での設定標準化支援

## エラーハンドリング

### 1. 入力検証エラー
- **必須項目**: 未入力項目の明確な表示
- **形式エラー**: 具体的な修正方法の提示
- **重複エラー**: 既存データセットとの重複警告
- **権限エラー**: 権限不足の詳細説明

### 2. システムエラー
- **API通信エラー**: ネットワーク問題時の適切な処理
- **容量制限**: ストレージ容量不足時の警告
- **同時編集**: 競合状態の適切な処理
- **タイムアウト**: 長時間処理の中断・再開機能

### 3. データ整合性エラー
- **スキーマ矛盾**: スキーマとデータの不整合
- **参照エラー**: 関連データの不正参照
- **バージョン競合**: 同時更新による競合
- **復旧機能**: エラー時のデータ復旧支援

## 今後の改善予定

### 1. 機能拡張
- **ワークフロー**: データセット開設の承認ワークフロー
- **テンプレート共有**: 機関間でのテンプレート共有
- **自動化**: 定期的なデータセット作成の自動化

### 2. UI/UX改善
- **ウィザード**: ステップバイステップの開設ガイド
- **プレビュー強化**: より詳細な作成前プレビュー
- **ヘルプシステム**: 状況に応じたヘルプ表示

### 3. 連携機能
- **外部システム**: 他の研究データ管理システムとの連携
- **バージョン管理**: データセット構造のバージョン管理
- **マイグレーション**: 既存データセットの移行支援

---

**更新履歴**
- v1.12.0: 動的スキーマフォーム機能の強化
- v1.11.0: Excel連携機能の実装
- v1.10.0: 基本的なデータセット開設機能の実装
