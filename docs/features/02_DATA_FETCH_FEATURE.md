# 02. データ取得機能 - 詳細仕様書

## 概要
ARIM RDE Toolのデータ取得機能は、RDEシステムから研究データセット、画像ファイル、メタデータを一括取得し、ローカルに整理保存する機能です。段階的プログレス表示により、処理状況を詳細に把握できます。

## 実装ファイル
- **メインロジック**: `src/logic/basic_info_logic.py`
- **UI制御**: `src/classes/ui_controller.py`
- **データ管理**: `src/classes/data_manager.py`
- **バッチ処理**: `src/classes/batch_processor.py`
- **画像処理**: `src/classes/image_processor.py`

## 主要機能

### 1. 基本情報取得 (ALL)
- **実装場所**: `UIController.fetch_basic_info()`
- **処理内容**: 全ユーザー・グループ・データセット情報の一括取得
- **プログレス表示**: 10段階の詳細進捗表示

#### 取得データの詳細
| 段階 | 処理内容 | 出力ファイル |
|------|----------|------------|
| 1 | ユーザー情報取得 | `user_info.json` |
| 2 | グループ詳細情報取得 | `group_info.json` |
| 3 | サブグループ情報取得 | `subgroup_info.json` |
| 4 | テンプレート情報取得 | `template_*.json` |
| 5 | データセット一覧取得 | `datasets_list.json` |
| 6 | データセット詳細取得 | `dataset_*.json` |
| 7 | データエントリ情報取得 | `data_entries_*.json` |
| 8 | ファイル情報取得 | `file_info_*.json` |
| 9 | 画像ファイル取得 | `output/images/` |
| 10 | まとめファイル作成 | `summary.xlsx` |

### 2. 基本情報取得 (検索)
- **実装場所**: `UIController.fetch_basic_info_self()`
- **処理内容**: 検索条件に基づく限定的なデータ取得
- **対象**: 指定されたグループ・データセットのみ

### 3. 共通情報のみ取得
- **実装場所**: `UIController.fetch_common_info_only()`
- **処理内容**: 基本メタデータのみの軽量取得
- **プログレス表示**: 6段階の最適化された進捗表示

## UI構成

### データ取得モード時のレイアウト
```
[基本情報取得ボタン群]
┌─────────────────────────────────────┐
│ [基本情報取得(ALL)] [基本情報取得(検索)] │
│ [共通情報のみ取得]                    │
└─────────────────────────────────────┘

[画像取得設定]
┌─────────────────────────────────────┐
│ 画像取得上限: [100枚 ▼]              │
│ □ ARIM拡張機能を有効化               │
└─────────────────────────────────────┘

[個別実行ボタン群]
┌─────────────────────────────────────┐
│ [グループ詳細] [データセット一覧]      │
│ [画像一括取得] [Excelまとめ出力]      │
└─────────────────────────────────────┘
```

### UIコンポーネントの詳細

#### 1. 基本情報取得ボタン
- **基本情報取得(ALL)**: 全データの完全取得
- **基本情報取得(検索)**: 検索対象のみ取得
- **共通情報のみ取得**: メタデータのみ軽量取得

#### 2. 画像取得設定
- **画像取得上限**: ドロップダウンで上限数設定
  - 選択肢: 50, 100, 200, 500, 1000, 制限なし
- **ARIM拡張機能**: ARIM連携データの処理有効化

#### 3. 個別実行ボタン
- **グループ詳細**: グループ情報のみ取得
- **データセット一覧**: データセット情報のみ取得
- **画像一括取得**: 画像ファイルのみ一括取得
- **Excelまとめ出力**: 取得済みデータのExcel出力

## 技術仕様

### 1. データ取得フロー
```python
def fetch_basic_info(self):
    """基本情報取得の全体フロー"""
    1. Bearer Token認証確認
    2. プログレスダイアログ表示
    3. 段階的データ取得実行
    4. エラーハンドリング
    5. 完了通知・結果表示
```

### 2. プログレス表示システム
- **ProgressWorker**: スレッドセーフなプログレス表示
- **段階的更新**: 各処理段階での進捗通知
- **キャンセル機能**: 長時間処理の中断機能

### 3. データ保存構造
```
output/
├── rde/
│   ├── data/           # JSONデータファイル
│   │   ├── user_info.json
│   │   ├── group_info.json
│   │   ├── datasets/   # データセット別
│   │   └── samples/    # 試料情報
│   └── meta/           # メタデータ
├── images/             # 画像ファイル
│   ├── original/       # 元画像
│   └── thumbnails/     # サムネイル
└── summary.xlsx        # まとめExcelファイル
```

## ARIM拡張機能

### 1. ARIM連携データ処理
- **入力ファイル**: `input/ai/arim/converted.xlsx`
- **検索方式**: 
  - ARIMNO列での完全一致検索（優先）
  - 課題番号での末尾4桁一致検索（フォールバック）

### 2. 拡張データ項目
- **ARIM番号**: 研究課題識別番号
- **課題名**: 研究課題の名称
- **研究者情報**: 主任研究者・分担研究者
- **期間・予算**: 研究期間と予算情報

### 3. 連携処理
```python
def process_arim_extension(dataset_info):
    """ARIM拡張データとの連携処理"""
    1. ARIM Excel ファイル読み込み
    2. データセット情報との照合
    3. 拡張情報の統合
    4. 統合データの出力
```

## 画像処理機能

### 1. 画像取得制御
- **上限設定**: ユーザー指定の上限数制御
- **形式対応**: JPEG, PNG, GIF, SVG等
- **サイズ管理**: 大容量画像の効率的処理

### 2. 画像保存管理
- **階層保存**: データセット別の階層構造保存
- **重複排除**: 同一画像の重複取得防止
- **メタデータ**: 画像情報のメタデータ保存

### 3. エラーハンドリング
- **取得失敗**: 個別画像の取得失敗時の継続処理
- **ネットワークエラー**: 接続問題時の再試行機能
- **容量制限**: ディスク容量不足時の警告

## Excel出力機能

### 1. まとめファイル構成
- **データセット一覧**: 全データセットの概要
- **データエントリ**: 個別データの詳細
- **試料情報**: 試料データの統合表示
- **統計情報**: 取得データの統計サマリー

### 2. 出力フォーマット
- **ファイル形式**: .xlsx (Excel 2007以降)
- **シート構成**: 機能別の複数シート
- **書式設定**: 見やすい表形式とフォント設定

### 3. カスタマイズ機能
- **フィルタ条件**: 出力対象の絞り込み
- **項目選択**: 出力項目のカスタマイズ
- **書式オプション**: 表示形式の調整

## エラーハンドリング

### 1. 認証エラー
- **Bearer Token無効**: 再ログイン誘導
- **権限不足**: 適切なエラーメッセージ表示
- **セッション期限**: 自動再認証機能

### 2. ネットワークエラー
- **接続タイムアウト**: 再試行機能
- **サーバーエラー**: 詳細エラー情報表示
- **データ不整合**: 整合性チェック機能

### 3. ファイルシステムエラー
- **ディスク容量不足**: 警告表示と処理中断
- **権限エラー**: 書き込み権限の確認
- **パス長制限**: 長いパス名の適切な処理

## パフォーマンス最適化

### 1. 並行処理
- **スレッド分離**: UI更新とデータ取得の分離
- **バッチ処理**: 効率的な一括処理
- **メモリ管理**: 大容量データの適切な処理

### 2. キャッシュ機能
- **データキャッシュ**: 取得済みデータの再利用
- **画像キャッシュ**: 画像ファイルの重複取得防止
- **メタデータキャッシュ**: 高速アクセス用インデックス

### 3. 進捗表示
- **リアルタイム更新**: 処理状況の即座反映
- **詳細メッセージ**: 現在の処理内容表示
- **時間予測**: 残り時間の概算表示

## 今後の改善予定

### 1. 機能拡張
- **増分取得**: 差分のみの効率的取得
- **並列ダウンロード**: 複数ファイルの同時取得
- **クラウド連携**: クラウドストレージとの連携

### 2. UI/UX改善
- **プレビュー機能**: 取得前のデータプレビュー
- **フィルタ機能**: 高度な絞り込み条件
- **カスタマイズ**: ユーザー設定の永続化

### 3. データ品質
- **検証機能**: データ整合性の自動チェック
- **メタデータ拡張**: より詳細な情報取得
- **形式対応**: 新しいデータ形式への対応

---

**更新履歴**
- v1.12.0: UI/UX大幅改善、プログレス表示の最適化
- v1.11.0: ARIM拡張機能の統合
- v1.10.0: 段階的プログレス表示システムの実装
