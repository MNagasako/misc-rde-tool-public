# 07. リクエスト解析機能 - 詳細仕様書

## 概要
ARIM RDE Toolのリクエスト解析機能は、RDEシステムとの通信内容を詳細に分析・表示する開発支援機能です。API呼び出しの監視、レスポンス解析、エラー診断により、システム連携の問題解決とデバッグ作業を効率化します。

## 実装ファイル
- **UI制御**: `src/classes/ui_controller.py`
- **解析ロジック**: `src/logic/request_analyzer_logic.py`
- **ネットワーク監視**: `src/classes/network_monitor.py`
- **データ可視化**: `src/classes/data_visualizer.py`

## 主要機能

### 1. リアルタイム通信監視
- **HTTP監視**: RDEシステムとのHTTP/HTTPS通信の監視
- **API呼び出し追跡**: 各APIエンドポイントへの呼び出し記録
- **タイミング分析**: 通信時間・レスポンス時間の測定
- **エラー検出**: 通信エラー・HTTPエラーの自動検出

### 2. WebView操作支援
- **WebView制御**: ブラウザ操作の可視化・制御
- **JavaScript実行**: カスタムJavaScriptの実行・テスト
- **DOM操作**: HTML要素の検査・操作支援
- **Cookie分析**: Cookie・セッション情報の詳細表示

### 3. データ解析機能
- **JSON整形**: APIレスポンスの見やすい整形表示
- **データ構造分析**: 複雑なデータ構造の可視化
- **スキーマ推定**: データ構造からのスキーマ推定
- **差分比較**: 複数レスポンスの差分表示

### 4. デバッグ支援
- **ログ統合**: 各種ログ情報の統合表示
- **エラー診断**: エラー原因の自動分析・提案
- **パフォーマンス分析**: 処理性能の詳細分析
- **トレース機能**: 処理フローの詳細追跡

## UI構成

### リクエスト解析モード時のレイアウト
```
[解析制御パネル]
┌─────────────────────────────────────┐
│ ■ 監視制御                          │
│   [監視開始] [監視停止] [クリア]     │
│   WebView操作: [有効化] [無効化]     │
│                                     │
│ ■ フィルタ設定                      │
│   URL: [フィルタパターン入力]        │
│   メソッド: [☑GET ☑POST ☑PUT]       │
│   ステータス: [☑200 ☑400 ☑500]      │
└─────────────────────────────────────┘

[WebView表示エリア]
┌─────────────────────────────────────┐
│ [操作可能なWebViewブラウザ]          │
│                                     │
│ 現在のURL: https://rde.nims.go.jp   │
│ 操作状況: アクティブ                 │
└─────────────────────────────────────┘

[解析結果表示]
┌─────────────────────────────────────┐
│ [リクエスト一覧] [詳細解析] [統計]   │
│                                     │
│ ■ 通信ログ一覧                      │
│   Time    | Method | URL | Status   │
│   10:30:15| GET   |/api/user| 200   │
│   10:30:16| POST  |/api/data| 201   │
│                                     │
│ ■ 選択リクエスト詳細                │
│   [ヘッダー] [ペイロード] [レスポンス] │
│                                     │
│ ■ 統計情報                          │
│   総リクエスト数: 45                │
│   平均レスポンス時間: 250ms          │
│   エラー率: 2.3%                    │
└─────────────────────────────────────┘
```

### UIコンポーネントの詳細

#### 1. 監視制御パネル
- **監視開始/停止**: 通信監視の開始・停止制御
- **ログクリア**: 蓄積されたログ情報のクリア
- **WebView制御**: WebViewの操作有効化・無効化
- **設定保存**: 監視設定の保存・復元

#### 2. フィルタ設定
- **URLフィルタ**: 特定URLパターンのみを監視
- **HTTPメソッドフィルタ**: GET、POST、PUT等の選択
- **ステータスコードフィルタ**: 成功・エラー別の表示
- **時間範囲フィルタ**: 指定時間範囲の通信表示

#### 3. WebView表示エリア
- **完全操作**: 通常のブラウザと同様の操作
- **URL表示**: 現在のページURL表示
- **操作状態**: WebViewの操作可能状態表示
- **デバッグ情報**: ページ読み込み状況等の詳細情報

#### 4. 通信ログ一覧
- **時系列表示**: 通信発生順での一覧表示
- **ソート機能**: 各列での並び替え機能
- **検索機能**: ログ内容での検索・絞り込み
- **エクスポート**: ログデータのファイル出力

#### 5. 詳細解析パネル
- **ヘッダー情報**: HTTPヘッダーの詳細表示
- **リクエストボディ**: 送信データの整形表示
- **レスポンスボディ**: 受信データの解析表示
- **メタデータ**: 通信時間、サイズ等の詳細情報

## 技術仕様

### 1. 通信監視アーキテクチャ
```python
class NetworkMonitor:
    """ネットワーク通信監視クラス"""
    def __init__(self):
        self.interceptor = RequestInterceptor()
        self.analyzer = RequestAnalyzer()
        self.storage = LogStorage()
    
    def start_monitoring(self):
        """監視開始処理"""
        1. インターセプター設定
        2. WebEngineProfile設定
        3. イベントハンドラー登録
        4. ログ記録開始
```

### 2. WebView統合制御
```python
def setup_webview_analysis_mode(self):
    """WebView解析モード設定"""
    1. WebView表示設定
    2. 操作有効化
    3. インターセプター設定
    4. デバッグ機能有効化
    5. 状態監視開始
```

### 3. データ構造
```json
{
  "request_log": {
    "timestamp": "2025-01-01T10:30:15Z",
    "method": "POST",
    "url": "https://rde.nims.go.jp/api/data",
    "headers": {
      "Authorization": "Bearer ...",
      "Content-Type": "application/json"
    },
    "request_body": "{\"data\": \"value\"}",
    "response_status": 201,
    "response_headers": {
      "Content-Type": "application/json"
    },
    "response_body": "{\"id\": 123, \"status\": \"created\"}",
    "timing": {
      "start_time": 1640995815000,
      "end_time": 1640995815250,
      "duration": 250
    },
    "error": null
  }
}
```

## 通信解析機能

### 1. HTTPインターセプター
- **リクエスト監視**: 送信されるHTTPリクエストの捕捉
- **レスポンス監視**: 受信されるHTTPレスポンスの捕捉
- **タイミング測定**: 通信時間の精密測定
- **エラーハンドリング**: 通信エラーの詳細記録

### 2. データ解析エンジン
```python
class RequestAnalyzer:
    """リクエスト解析エンジン"""
    def analyze_request(self, request_data):
        """リクエスト詳細解析"""
        1. HTTPヘッダー解析
        2. ペイロードデータ解析
        3. 認証情報抽出
        4. パラメータ分析
        
    def analyze_response(self, response_data):
        """レスポンス詳細解析"""
        1. ステータスコード分析
        2. レスポンスボディ解析
        3. エラー詳細抽出
        4. データ構造分析
```

### 3. JSON解析・整形
- **構文解析**: JSON形式の検証・解析
- **階層表示**: ネストされたデータの見やすい表示
- **型推定**: データ型の自動推定・表示
- **値統計**: 数値データの統計情報表示

## WebView制御機能

### 1. 動的制御システム
- **表示制御**: WebViewの表示・非表示切替
- **サイズ調整**: 解析モードに応じたサイズ調整
- **操作制御**: マウス・キーボード操作の有効化制御
- **フォーカス管理**: WebViewフォーカスの適切な管理

### 2. JavaScript実行環境
```python
def execute_javascript(self, script):
    """JavaScript実行機能"""
    1. スクリプト検証
    2. 実行環境準備
    3. スクリプト実行
    4. 結果取得・表示
    5. エラーハンドリング
```

### 3. DOM操作支援
- **要素検査**: HTML要素の詳細検査
- **属性表示**: 要素属性の一覧表示
- **イベント監視**: DOM イベントの監視・記録
- **動的変更**: 要素の動的変更・テスト

## ログ管理・保存機能

### 1. 階層ログシステム
- **メモリログ**: 高速アクセス用のメモリ内ログ
- **ファイルログ**: 永続保存用のファイルログ
- **データベースログ**: 検索・分析用の構造化ログ
- **圧縮アーカイブ**: 長期保存用の圧縮ログ

### 2. ログローテーション
```python
class LogRotationManager:
    """ログローテーション管理"""
    def __init__(self, max_size="100MB", max_files=10):
        self.max_size = max_size
        self.max_files = max_files
    
    def rotate_logs(self):
        """ログファイルのローテーション"""
        1. ファイルサイズチェック
        2. 新ファイル作成
        3. 旧ファイル圧縮
        4. 古いファイル削除
```

### 3. エクスポート機能
- **CSV出力**: 表形式でのデータ出力
- **JSON出力**: 構造化データでの出力
- **HAR形式**: 標準的なHTTPアーカイブ形式
- **レポート生成**: 分析結果の報告書生成

## 統計・可視化機能

### 1. 通信統計
- **リクエスト数**: 時間別・URL別のリクエスト数統計
- **レスポンス時間**: 平均・最大・最小レスポンス時間
- **エラー率**: HTTPエラーの発生率・傾向
- **データ量**: 送受信データ量の統計

### 2. パフォーマンス分析
- **ボトルネック検出**: 処理時間の長いAPIの特定
- **トレンド分析**: 時系列でのパフォーマンス変化
- **比較分析**: 異なる条件下での性能比較
- **最適化提案**: 改善案の自動提案

### 3. 可視化グラフ
- **時系列グラフ**: 通信量・レスポンス時間の推移
- **分布グラフ**: レスポンス時間・データサイズの分布
- **エラー分析**: エラー種別・発生傾向の可視化
- **ヒートマップ**: 時間・URL別の通信密度表示

## 開発支援機能

### 1. API テスト機能
- **カスタムリクエスト**: 任意のAPIリクエスト送信
- **認証テスト**: Bearer Token等の認証テスト
- **パラメータテスト**: 異なるパラメータでの動作確認
- **エラー再現**: 特定エラー条件の再現テスト

### 2. スキーマ推定
```python
def infer_schema(json_data):
    """JSONデータからのスキーマ推定"""
    1. データ構造解析
    2. 型情報抽出
    3. 必須・オプション判定
    4. スキーマ生成
    5. 検証ルール提案
```

### 3. モック機能
- **レスポンスモック**: APIレスポンスの模擬データ生成
- **エラーシミュレーション**: 各種エラー状況のシミュレーション
- **遅延シミュレーション**: ネットワーク遅延の再現
- **オフラインテスト**: オフライン環境でのテスト支援

## セキュリティ・プライバシー

### 1. 機密情報保護
- **認証情報マスク**: API Key、Tokenの自動マスク表示
- **個人情報除去**: ログからの個人情報自動除去
- **暗号化保存**: 機密ログの暗号化保存
- **アクセス制御**: ログファイルのアクセス権限設定

### 2. データ漏洩防止
- **ローカル処理**: 機密データの外部送信防止
- **一時ファイル管理**: 一時ファイルの安全な削除
- **メモリクリア**: 機密データのメモリからの確実な削除
- **ログレベル制御**: 機密度に応じたログレベル設定

## 今後の改善予定

### 1. 機能拡張
- **プロトコル拡張**: WebSocket、GraphQL等の対応
- **自動テスト**: API回帰テストの自動実行
- **パフォーマンス監視**: 継続的なパフォーマンス監視

### 2. 解析機能強化
- **機械学習**: 異常通信の自動検出
- **予測分析**: 通信パターンの予測・警告
- **自動診断**: 問題の自動診断・解決提案

### 3. 統合機能
- **開発ツール連携**: IDE、デバッガーとの連携
- **CI/CD統合**: 継続的インテグレーションとの統合
- **ドキュメント生成**: API仕様書の自動生成

---

**更新履歴**
- v1.12.0: WebView操作制御の強化、UI/UX改善
- v1.11.0: 統計・可視化機能の追加
- v1.10.0: 基本的なリクエスト解析機能の実装
