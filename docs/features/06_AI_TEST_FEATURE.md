# 06. AIテスト機能 - 詳細仕様書

## 概要
ARIM RDE ToolのAIテスト機能は、AI（人工知能）との対話インターフェースを提供し、研究データの分析、解釈、推論支援を行う機能です。複数のAIプロバイダー対応、課題番号連携、プロンプトテンプレート機能により、効率的な研究支援を実現します。

## 実装ファイル
- **UI制御**: `src/classes/ui_controller.py`
- **AIロジック**: `src/logic/ai_test_logic.py`
- **設定管理**: `src/config/ai_config.json`
- **プロンプト管理**: `src/templates/ai_prompts.json`

## 主要機能

### 1. AIプロバイダー管理
- **複数プロバイダー対応**: OpenAI、Claude、Gemini等
- **API設定**: 各プロバイダーのAPI Key管理
- **モデル選択**: 用途に応じたAIモデルの選択
- **負荷分散**: 複数プロバイダー間での負荷分散

### 2. 課題番号連携
- **課題検索**: 既存課題番号の検索・補完機能
- **課題コンテキスト**: 課題情報をAIに提供
- **研究分野特化**: 課題分野に応じたAI応答調整
- **履歴管理**: 課題別の対話履歴管理

### 3. プロンプト管理
- **テンプレート**: よく使用するプロンプトのテンプレート化
- **カテゴリ分類**: 用途別のプロンプト分類
- **カスタマイズ**: ユーザー独自のプロンプト作成
- **共有機能**: プロンプトの機関内共有

### 4. 対話インターフェース
- **リアルタイム対話**: AIとのリアルタイム会話
- **履歴表示**: 過去の対話履歴の表示・検索
- **結果保存**: 重要な対話結果の保存・エクスポート
- **コンテキスト維持**: 会話文脈の継続管理

## UI構成

### AIテストモード時のレイアウト
```
[AIテストインターフェース]
┌─────────────────────────────────────┐
│ ■ AI設定                           │
│   プロバイダー: [OpenAI ▼]          │
│   モデル: [GPT-4 ▼]                │
│                                     │
│ ■ 課題情報                          │
│   課題番号: [検索可能コンボボックス]  │
│   [課題詳細情報表示]                │
│                                     │
│ ■ プロンプト入力                    │
│   [拡大可能テキストエリア] [🔍]      │
│   テンプレート: [選択 ▼] [適用]      │
│                                     │
│ ■ 送信・制御                        │
│   [送信] [クリア] [履歴]            │
│                                     │
│ ■ AI応答                           │
│   [拡大可能表示エリア] [🔍]          │
│                                     │
│ ■ ログ・デバッグ                    │
│   [システムログ表示] [🔍]            │
└─────────────────────────────────────┘
```

### UIコンポーネントの詳細

#### 1. AI設定パネル
- **プロバイダー選択**: ドロップダウンでのAI提供者選択
- **モデル選択**: 選択プロバイダーの利用可能モデル表示
- **パラメータ設定**: 温度、最大トークン数等の詳細設定
- **接続状態**: APIの接続状況・認証状態表示

#### 2. 課題連携パネル
- **課題番号検索**: 入力補完機能付きの課題番号選択
- **課題詳細**: 選択した課題の詳細情報表示
- **研究分野**: 課題の研究分野に基づくAI設定調整
- **関連データ**: 課題に関連するデータセット情報

#### 3. プロンプト入力エリア
- **拡大表示**: テキストエリアの拡大表示機能
- **テンプレート選択**: 事前定義されたプロンプトテンプレート
- **履歴参照**: 過去のプロンプト履歴からの選択
- **文字数カウント**: 入力文字数・トークン数の表示

#### 4. AI応答エリア
- **マークダウン対応**: リッチテキストでの応答表示
- **コード構文強調**: プログラムコードの見やすい表示
- **数式表示**: LaTeX数式の適切なレンダリング
- **画像表示**: AI生成画像の表示対応

#### 5. ログ・デバッグエリア
- **システムログ**: API通信・エラー情報の表示
- **デバッグ情報**: 開発者向けの詳細情報
- **JSON表示**: APIレスポンスの生JSON表示
- **フィルタ機能**: ログレベル別の表示フィルタ

## 技術仕様

### 1. AI対話フロー
```python
def process_ai_request(prompt, context):
    """AI対話処理の全体フロー"""
    1. プロンプト前処理
    2. コンテキスト情報付加
    3. AIプロバイダーAPI呼び出し
    4. レスポンス後処理
    5. 結果表示・保存
    6. 履歴更新
```

### 2. プロバイダー抽象化
```python
class AIProvider:
    """AIプロバイダーの抽象基底クラス"""
    def __init__(self, config):
        self.config = config
    
    def send_request(self, prompt, context=None):
        """AI要求送信の統一インターフェース"""
        pass
    
    def parse_response(self, response):
        """レスポンス解析の統一処理"""
        pass
```

### 3. 設定ファイル構成
```json
{
  "ai_config": {
    "providers": [
      {
        "name": "OpenAI",
        "api_key": "sk-...",
        "models": ["gpt-4", "gpt-3.5-turbo"],
        "default_model": "gpt-4",
        "parameters": {
          "temperature": 0.7,
          "max_tokens": 2048
        }
      }
    ],
    "default_provider": "OpenAI",
    "context_length": 4000
  }
}
```

## プロンプトテンプレート機能

### 1. テンプレートカテゴリ
- **データ分析**: データ解釈・統計分析支援
- **文献調査**: 研究論文の要約・比較
- **実験計画**: 実験設計・手順の提案
- **結果解釈**: 実験結果の解釈・考察支援
- **論文執筆**: 論文作成・校正支援

### 2. テンプレート構造
```json
{
  "templates": [
    {
      "id": "data_analysis_01",
      "name": "データ傾向分析",
      "category": "データ分析",
      "prompt": "以下のデータについて統計的傾向を分析してください：\n{data}\n\n分析観点：\n1. 基本統計量\n2. 相関関係\n3. 外れ値\n4. 推奨する次のステップ",
      "variables": ["data"],
      "description": "数値データの基本的な統計分析を行います"
    }
  ]
}
```

### 3. 動的プロンプト生成
```python
def generate_prompt(template, variables):
    """テンプレートからの動的プロンプト生成"""
    1. テンプレート読み込み
    2. 変数置換処理
    3. コンテキスト情報付加
    4. 最終プロンプト生成
```

## 課題番号連携機能

### 1. 課題データベース
- **データソース**: RDEシステムの課題データベース
- **キャッシュ**: ローカルキャッシュでの高速検索
- **更新**: 定期的なデータ同期・更新
- **検索インデックス**: 高速検索のためのインデックス

### 2. 検索・補完機能
```python
def search_projects(query):
    """課題番号検索・補完機能"""
    1. 入力文字列解析
    2. 部分一致検索実行
    3. 候補リスト生成
    4. 関連度スコア計算
    5. 結果ソート・返却
```

### 3. コンテキスト統合
- **課題情報**: 課題名、研究分野、期間等
- **研究者情報**: 主任研究者、分担研究者
- **関連データ**: 課題に関連するデータセット
- **過去履歴**: 同課題での過去のAI対話履歴

## ログ・デバッグ機能

### 1. 多層ログシステム
- **ユーザーログ**: ユーザー向けの分かりやすいメッセージ
- **システムログ**: システム管理者向けの詳細情報
- **デバッグログ**: 開発者向けの技術的詳細
- **API通信ログ**: AI APIとの通信記録

### 2. ログフィルタリング
- **レベル別表示**: ERROR、WARN、INFO、DEBUG
- **時間範囲**: 指定期間のログ表示
- **キーワード検索**: ログ内容のテキスト検索
- **エクスポート**: ログデータのファイル出力

### 3. リアルタイム表示
- **ストリーミング**: リアルタイムログ更新
- **自動スクロール**: 新しいログの自動表示
- **ハイライト**: エラー・警告の強調表示
- **通知**: 重要なイベントの通知機能

## UI/UX改善機能

### 1. テキストエリア拡大機能
- **ポップアップ表示**: 大きなウィンドウでの詳細表示
- **キーボードショートカット**: Ctrl+A、Ctrl+C、Escape
- **HTML/テキスト判定**: 適切な表示形式の自動選択
- **クリップボード対応**: 選択・全文のコピー機能

### 2. レスポンス表示分離
- **問い合わせ結果**: AIからの実際の回答
- **システム情報**: ログ・デバッグ・JSON情報
- **タブ切替**: 情報種別による表示切替
- **フォント設定**: 読みやすさを重視したフォント選択

### 3. 上部メッセージ制御
- **自動非表示**: AIテスト時の不要メッセージ非表示
- **必要時表示**: 重要な情報の適切な表示
- **レイアウト最適化**: 画面領域の効率的利用
- **動的制御**: モードに応じた表示内容調整

## セキュリティ・プライバシー

### 1. API Key管理
- **暗号化保存**: API Keyの暗号化ローカル保存
- **環境変数**: 環境変数での設定オプション
- **権限管理**: API使用権限の適切な制御
- **監査ログ**: API使用状況の記録

### 2. データ保護
- **ローカル処理**: 機密データのローカル処理優先
- **匿名化**: 必要に応じたデータ匿名化
- **削除機能**: 対話履歴の安全な削除
- **暗号化通信**: HTTPS通信の強制

### 3. プライバシー配慮
- **データ最小化**: 必要最小限のデータ送信
- **一時的保存**: 短期間でのデータ削除
- **オプトアウト**: AI機能の無効化選択
- **透明性**: データ使用状況の明示

## エラーハンドリング

### 1. API通信エラー
- **接続失敗**: ネットワーク問題時の適切な処理
- **認証エラー**: API Key問題の詳細説明
- **レート制限**: 使用量制限時の待機・再試行
- **タイムアウト**: 長時間応答なしの処理

### 2. 応答エラー
- **不正レスポンス**: AIからの不正な応答処理
- **形式エラー**: 期待と異なる形式の応答処理
- **内容フィルタ**: 不適切な内容の検出・処理
- **制限超過**: トークン制限超過時の処理

### 3. システムエラー
- **メモリ不足**: 大容量データ処理時の制限
- **ファイルエラー**: 設定・履歴ファイルの問題
- **権限エラー**: ファイル・ネットワークアクセス権限
- **予期しないエラー**: 未知のエラーの適切な処理

## 今後の改善予定

### 1. 機能拡張
- **音声入力**: 音声認識でのプロンプト入力
- **画像認識**: 画像データの解析・説明機能
- **ファイル処理**: 各種ファイル形式の直接処理
- **リアルタイム協調**: 複数ユーザーでの協調作業

### 2. AI機能強化
- **専門モデル**: 研究分野特化AIモデルの統合
- **学習機能**: ユーザー固有の学習・適応機能
- **推論連鎖**: 複雑な推論プロセスの可視化
- **確信度表示**: AI応答の信頼度表示

### 3. 統合機能
- **データ連携**: RDEデータとの直接連携強化
- **ワークフロー**: AI支援研究ワークフローの構築
- **外部ツール**: 他の研究ツールとの連携
- **レポート生成**: AI支援による研究レポート自動生成

---

**更新履歴**
- v1.12.0: UI/UX大幅改善、テキストエリア拡大機能、レスポンス表示分離
- v1.11.0: 課題番号連携機能の強化、プロンプトテンプレート機能
- v1.10.0: 基本的なAI対話機能の実装
